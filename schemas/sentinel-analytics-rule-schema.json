{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Microsoft Sentinel Analytics Rule",
  "description": "Schema for Microsoft Sentinel Analytics Rules - Flexible validation",
  "type": "object",
  "required": [
    "id", "name", "description", "severity", "requiredDataConnectors",
    "queryFrequency", "queryPeriod", "triggerOperator", "triggerThreshold",
    "tactics", "query", "entityMappings", "version", "kind"
  ],
  "properties": {
    "id": {
      "type": "string",
      "pattern": "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$",
      "description": "Unique identifier for the rule (GUID format)"
    },
    "name": {
      "type": "string",
      "minLength": 1,
      "maxLength": 260,
      "description": "Display name of the analytics rule"
    },
    "description": {
      "type": "string",
      "minLength": 1,
      "maxLength": 5000,
      "description": "Description of what the rule detects. Should be clear and informative."
    },
    "severity": {
      "type": "string",
      "enum": ["Informational", "Low", "Medium", "High"],
      "description": "Severity level of alerts generated by this rule"
    },
    "requiredDataConnectors": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["connectorId", "dataTypes"],
        "properties": {
          "connectorId": {
            "type": "string",
            "pattern": "^[A-Za-z][A-Za-z0-9]*$",
            "description": "Data connector identifier"
          },
          "dataTypes": {
            "type": "array",
            "items": {
              "type": "string",
              "minLength": 1
            },
            "minItems": 1
          }
        }
      },
      "minItems": 1
    },
    "queryFrequency": {
      "type": "string",
      "pattern": "^P([0-9]+D)?(T([0-9]+H)?([0-9]+M)?([0-9]+S)?)?$",
      "description": "How often the query should run (ISO 8601 duration)"
    },
    "queryPeriod": {
      "type": "string", 
      "pattern": "^P([0-9]+D)?(T([0-9]+H)?([0-9]+M)?([0-9]+S)?)?$",
      "description": "Time window for the query to look back (ISO 8601 duration)"
    },
    "triggerOperator": {
      "type": "string",
      "enum": ["gt", "lt", "eq", "ne"],
      "description": "Operator for trigger threshold comparison"
    },
    "triggerThreshold": {
      "type": "integer",
      "minimum": 0,
      "description": "Threshold value for triggering the rule"
    },
    "status": {
      "type": "string",
      "enum": ["Available", "Disabled"],
      "description": "Status of the analytics rule"
    },
    "tactics": {
      "type": "array",
      "items": {
        "type": "string",
        "pattern": "^[A-Z][a-zA-Z]{2,30}$",
        "description": "MITRE ATT&CK tactic name (e.g., InitialAccess, Persistence)"
      },
      "minItems": 1
    },
    "techniques": {
      "type": "array",
      "items": {
        "type": "string",
        "pattern": "^T[0-9]{4}(\\.[0-9]{3})?$"
      }
    },
    "relevantTechniques": {
      "type": "array",
      "items": {
        "type": "string",
        "pattern": "^T[0-9]{4}(\\.[0-9]{3})?$"
      }
    },
    "tags": {
      "type": "array",
      "items": {
        "type": "string"
      }
    },
    "query": {
      "type": "string",
      "minLength": 1,
      "description": "KQL query for the analytics rule"
    },
    "entityMappings": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["entityType", "fieldMappings"],
        "properties": {
          "entityType": {
            "type": "string",
            "pattern": "^[A-Z][a-zA-Z0-9]*$",
            "description": "Sentinel entity type (e.g., Account, IP, Host)"
          },
          "fieldMappings": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["identifier", "columnName"],
              "properties": {
                "identifier": {
                  "type": "string"
                },
                "columnName": {
                  "type": "string"
                }
              }
            },
            "minItems": 1
          }
        }
      },
      "minItems": 1
    },
    "incidentConfiguration": {
      "type": "object",
      "properties": {
        "createIncident": {
          "type": "boolean"
        },
        "groupingConfiguration": {
          "type": "object",
          "properties": {
            "enabled": {
              "type": "boolean"
            },
            "reopenClosedIncident": {
              "type": "boolean"
            },
            "lookbackDuration": {
              "type": "string",
              "pattern": "^P([0-9]+D)?(T([0-9]+H)?([0-9]+M)?([0-9]+S)?)?$"
            },
            "matchingMethod": {
              "type": "string",
              "enum": ["AllEntities", "AnyAlert", "Selected"]
            },
            "groupByEntities": {
              "type": "array",
              "items": {
                "type": "string"
              }
            }
          }
        }
      }
    },
    "eventGroupingSettings": {
      "type": "object",
      "properties": {
        "aggregationKind": {
          "type": "string",
          "enum": ["SingleAlert", "AlertPerResult"]
        }
      }
    },
    "suppressionDuration": {
      "type": "string",
      "pattern": "^P([0-9]+D)?(T([0-9]+H)?([0-9]+M)?([0-9]+S)?)?$"
    },
    "suppressionEnabled": {
      "type": "boolean"
    },
    "alertDetailsOverride": {
      "type": "object",
      "properties": {
        "alertDisplayNameFormat": {
          "type": "string"
        },
        "alertDescriptionFormat": {
          "type": "string"
        },
        "alertSeverityColumnName": {
          "type": "string"
        },
        "alertTacticsColumnName": {
          "type": "string"
        }
      }
    },
    "customDetails": {
      "type": "object",
      "additionalProperties": {
        "type": "string"
      }
    },
    "version": {
      "type": "string",
      "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$",
      "description": "Version of the rule (semver format)"
    },
    "kind": {
      "type": "string",
      "enum": [
        "Scheduled", 
        "NRT"
      ],
      "description": "Type of analytics rule that can be created by users"
    }
  },
  "additionalProperties": false
}